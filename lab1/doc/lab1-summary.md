#  Lab 1 实验总结

<!-- TOC -->

- [Lab 1 实验总结](#lab-1-实验总结)
    - [实验简介](#实验简介)
    - [实验设计](#实验设计)
        - [遍历文件夹](#遍历文件夹)
        - [正则表达式匹配](#正则表达式匹配)
        - [Token 位置](#token-位置)
    - [时间统计](#时间统计)

<!-- /TOC -->

## 实验简介

Lab 1 是完成一个建议的词法分析器。需要我们补全`lexical_analyzer.l`，之后使用 Flex 自动完成词法分析，输出 Token 的类型、位置等信息。

## 实验设计

这里对实验中遇到的主要问题和解决过程进行叙述，一些小地方不再介绍。

### 遍历文件夹

Google 后了解到可以使用`dirent.h`库，具体用法如下。

```c
#include <dirent.h>
struct dirent *dp;
DIR *dirp = opendir(dir);
while ((dp = readdir(dirp)) != NULL) {
    // "dp->d_name" is the file name.
    // Do everything you want.
}
closedir(dirp);
```

### 正则表达式匹配

用脚趾头也可以想到，这一部分是整个实验的重点，代码量其实不多，但有地方需要花时间（说的就是匹配注释）。

一开始我在想对于有公共前缀的两个`token`是不是要做复杂的处理（比如实验里出现的`[`和`[]`、`/`和`/*`等），结果之后发现我想多了，得益于 Flex 强大的匹配能力，对于有公共前缀的`token`，我们既不用把长一点的`token`放到前面（这样长的会被优先匹配），也不用强调`这个词后面必须跟着这个词、这个词后面不能跟着这个词`这些东西，只要无脑写就行了，Flex 自动为我们做好。

考虑到转义问题，加`backslash`（`\`）有点麻烦，不如直接无脑用`"`包起来，`"`里面的东西会匹配`exactly what it is`。

标识符用`[A-Za-z]+`，数字用`[0-9]+`，接下来说一说匹配注释。

直观来讲，匹配注释的原则是，从遇到第一个`/*`开始匹配，知道碰到第一个`*/`结束匹配，具体来讲，识别到`/*`后，之后碰到每一个`*`，都要看它后面紧接的是不是`/`，如果是则结束匹配，否则继续跳到下一个字符。

初版是`"/*"[.|\n]*"*/"`，一开始想着这样应该会把多个注释匹配成一个注释（“贪婪”地匹配），但是却发现竟然匹配不了任何的注释，没搞明白为什么（甚至现在也是，打算实验结束后问问同学），于是厚着脸皮 Google 之，最终找到可行答案，`"/*"([^*]|(\*+[^*/]))*"*"+"/"`，这个解法分三部分，开头识别`/*`，中间是`([^*]|(\*+[^*/]))*`，意思是，“`*`外的字符与一列`*`号”的一个或多个，结尾再识别一列`*`加上一个`/`表示结束注释。经测试，可以正确匹配多个`*`、多个注释等情况。

### Token 位置

这个花了很长时间，因为我一开始想的方法自己没有完成，耽误了很久。

位置包括行数和起始列数、终止列数。查阅完相关文档，了解到对于行数，直接在最前面加上`%option yylineno`，之后直接调用`yylineno`就可以了（处理下一个文件时，需要对其复位）。当然，不用`yylineno`，自己识别`\n`（包括直接的`\n`和注释里的`\n`）也是可以的。

让我花了很长时间的是检测列数，查文档的时候，知道有个`yylloc`这个东西，它包括`first_line`、` first_column` 、`last_line` 、 `last_column`四个部分，它要和 Bison 结合来使用，我就 Google，自己的笨笨脑袋到最后也没有弄清楚具体怎么操作（或许实验结束的时候助教可以贴一下？）。

后来，放弃这个方案，开始手动维护列数，具体来说，对于一般的词，需要把`column`加上词的长度；对于`EOL`，需要把`column`复位为 1；对于注释，需要检测里面是否有`\n`，如果有的话，找到最后一个`\n`的位置，从最后一个`\n`到结束的长度作为`cloumn`的新的值，如果没有，直接把`column`加上注释的长度。

## 时间统计

| 了解和学习 Flex | 核心代码 | 走错路线耽误的时间 | 合计 |
| --------------- | -------- | ------------------ | ---- |
| 2h              | 1h       | 4h                 | 7h   |

